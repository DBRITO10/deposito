<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>EXPEDI√á√ÉO SIMONETTI - OFICIAL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />

    <style>
        :root { 
            --red: #B22222; 
            --dark-red: #8B0000;
            --user-bar-bg: #d32f2f;
            --bg: #f8f9fa; 
        }
        body { background: var(--bg); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; }
        
        #userBar { background: var(--user-bar-bg); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 6px; color: white; margin-bottom: 10px; }
        .back-area { display: flex; align-items: center; gap: 15px; }
        .back-arrow { cursor: pointer; font-size: 24px; text-decoration: none; color: white; }
        
        h1 { background: var(--red); color: white; text-align: center; padding: 15px; border-radius: 4px; margin: 0 0 20px 0; font-size: 20px; text-transform: uppercase; }

        .dashboard { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        #chartContainer { width: 100%; max-width: 450px; height: 320px; }
        #totalVisual { font-size: 18px; font-weight: bold; color: var(--red); margin-top: 15px; border: 2px solid var(--red); padding: 10px 25px; border-radius: 50px; background: #fff; text-align: center; }

        .toolbar { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 15px; align-items: center; }
        #mainSearch { padding: 10px; border: 1px solid #ccc; border-radius: 6px; width: 220px; outline: none; }
        .btn-share { background: #1E90FF; color: white; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-weight: bold; }

        .table-container { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; }
        
        table.dataTable { border-collapse: collapse !important; width: 100% !important; margin: 0 !important; border: 1px solid #dee2e6 !important; }
        
        table.dataTable thead th { 
            background: var(--red) !important; 
            color: white !important; 
            text-align: center !important; 
            padding: 10px 5px !important;
            border: 1px solid var(--dark-red) !important;
            font-size: 13px;
            vertical-align: middle;
            min-width: 110px;
        }

        table.dataTable thead .sorting, 
        table.dataTable thead .sorting_asc, 
        table.dataTable thead .sorting_desc {
            background-position: center right 3px !important;
        }

        .filter-btn { 
            width: 95%; 
            margin-top: 8px;
            padding: 5px; 
            font-size: 10px; 
            border: 1px solid rgba(255,255,255,0.3); 
            border-radius: 4px; 
            cursor: pointer; 
            background: rgba(0,0,0,0.15); 
            color: white; 
            font-weight: bold; 
        }
        .filter-applied { background: #FFD700 !important; color: #000 !important; border: 1px solid #B8860B !important; }

        table.dataTable tbody td { 
            border: 1px solid #dee2e6 !important; 
            text-align: center !important; 
            padding: 10px !important; 
            font-size: 13px; 
        }
        
        .grupo-par { background-color: #ffffff !important; }
        .grupo-impar { background-color: #f8f9fa !important; }

        .pill { padding: 5px 12px; border-radius: 15px; font-size: 11px; font-weight: bold; display: inline-block; min-width: 95px; text-transform: uppercase; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 320px; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { background: var(--red); color: white; padding: 15px; font-weight: bold; text-align: center; }
        .modal-footer { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 15px; background: #f1f1f1; }
        .modal-footer button { padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-aplicar { background: var(--red); color: white; border: none; }
        
        .dropdown { position: relative; }
        .dropdown-content { display: none; position: absolute; right: 0; background: white; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 100; border-radius: 6px; min-width: 180px; }
        .dropdown:hover .dropdown-content { display: block; }
        .dropdown-content button { width: 100%; padding: 12px; border: none; background: none; text-align: left; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-weight: bold; }
    </style>
</head>
<body>

<div id="userBar">
    <div class="back-area">
        <a href="index.html" class="back-arrow">‚Üê</a>
        <span id="userName">Carregando...</span>
    </div>
    <button onclick="fazerLogoff()" style="background:transparent; color:white; border:1px solid #fff; padding:6px 15px; border-radius:4px; cursor:pointer; font-weight:bold;">SAIR</button>
</div>

<h1>EXPEDI√á√ÉO_M√ìVEIS SIMONETTI</h1>

<div class="dashboard">
    <div id="chartContainer"><canvas id="statusChart"></canvas></div>
    <div id="totalVisual">Carregando indicadores...</div>
</div>

<div class="toolbar">
    <input type="text" id="mainSearch" placeholder="üîç Buscar na tabela...">
    <div class="dropdown">
        <button class="btn-share">EXPORTAR / COMPARTILHAR</button>
        <div class="dropdown-content">
            <button onclick="exportarPDF()">üìÑ PDF Profissional (MS)</button>
            <button onclick="exportarExcel()">üìä Planilha Excel</button>
        </div>
    </div>
</div>

<div class="table-container">
    <table id="tabelaExp" class="display nowrap">
        <thead>
            <tr id="headerRow"></tr>
            <tr id="filterRow"></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="modalFiltro" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header" id="modalTitle">FILTRAR COLUNA</div>
        <div class="modal-body" id="listCheckboxes" style="max-height: 300px; overflow-y: auto; padding: 10px;"></div>
        <div class="modal-footer">
            <button onclick="limparFiltroColuna()">LIMPAR</button>
            <button onclick="$('#modalFiltro').hide()">FECHAR</button>
            <button onclick="toggleChecks(true)">TODOS</button>
            <button class="btn-aplicar" onclick="aplicarFiltro()">APLICAR</button>
        </div>
    </div>
</div>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/1-t9-DE1erEwcgZWVHMHq5JWBqWYAnZvh-_01__3fHno/export?format=csv&gid=0";
const colunas = ["DATA", "EXPEDI√á√ÉO", "CARREGAMENTO", "PLACA", "CENTRAL", "DESTINO", "BOX", "STATUS", "VEICULO"];

const coresStatus = { "EM SEPARA√á√ÉO": "#FF8C00", "CONFERIDO": "#0055b3", "FINALIZADO": "#0b6631", "CANCELADA": "#b30000" };
const coresVeic = { "CARRETA": "#006633", "TRUCK": "#4682B4", "PEQUENO": "#6A5ACD", "TOCO": "#8B4513" };

let table, chart, curIdx;

$(document).ready(function() {
    const usuarioAtivo = localStorage.getItem("username") || "Operador";
    $("#userName").text("Bem-vindo, " + usuarioAtivo);

    Papa.parse(csvUrl, {
        download: true, header: true, skipEmptyLines: true,
        complete: function(res) { inicializarPagina(res.data); }
    });
});

function inicializarPagina(dados) {
    const h = $("#headerRow").empty();
    const f = $("#filterRow").empty();
    
    colunas.forEach((c, i) => {
        h.append(`<th>${c}</th>`);
        f.append(`<th><button class="filter-btn" id="fbtn-${i}" onclick="openModal(${i},'${c}')">FILTRAR</button></th>`);
    });

    const body = $("#tabelaExp tbody").empty();
    let ultimoID = null;
    let classeCor = "grupo-par";

    dados.forEach(r => {
        let st = (r.STATUS || "").toUpperCase().trim();
        let vc = (r.VEICULO || "").toUpperCase().trim();
        let idAtual = r.ID || "S/ID";

        if(!st && !r.DATA) return;

        if (idAtual !== ultimoID) {
            classeCor = (classeCor === "grupo-par") ? "grupo-impar" : "grupo-par";
            ultimoID = idAtual;
        }

        body.append(`<tr class="${classeCor}" data-id="${idAtual}">
            <td>${r.DATA || ""}</td>
            <td>${r["EXPEDI√á√ÉO"] || r.EXPEDICAO || ""}</td>
            <td>${r.CARREGAMENTO || ""}</td>
            <td>${r.PLACA || ""}</td>
            <td>${r.CENTRAL || ""}</td>
            <td>${r.DESTINO || ""}</td>
            <td>${r.BOX || ""}</td>
            <td><span class="pill" style="background:${coresStatus[st] || '#ccc'}; color:#fff">${st}</span></td>
            <td><span class="pill" style="background:${coresVeic[vc] || '#eee'}; color:#fff; border:1px solid #ccc">${vc}</span></td>
        </tr>`);
    });

    table = $('#tabelaExp').DataTable({ 
        paging: false, 
        info: false, 
        dom: 'rt', 
        scrollX: true, 
        destroy: true, 
        ordering: true,
        orderCellsTop: true,
        autoWidth: false
    });

    $('#mainSearch').on('keyup', function() { table.search(this.value).draw(); updateDashboard(); });
    restaurarFiltrosPermanentes();
    updateDashboard();
}

function updateDashboard() {
    const visibleRows = table.rows({ search: 'applied' }).nodes().to$();
    let idsUnicos = new Set();
    let totalExpedicoes = 0;
    const statsStatus = {}; 

    visibleRows.each(function() {
        totalExpedicoes++; 
        let id = $(this).attr('data-id');
        let status = $(this).find('td:eq(7)').text().trim();
        
        if (id) idsUnicos.add(id);
        if (status) statsStatus[status] = (statsStatus[status] || 0) + 1;
    });

    $("#totalVisual").html(`
        <div style="line-height: 1.2;">
            <div>Total de Cargas: ${idsUnicos.size}</div>
            <div style="font-size: 13px; color: #666; font-weight: normal;">Total Expedi√ß√µes: ${totalExpedicoes}</div>
        </div>
    `);

    colunas.forEach((_, i) => {
        const memory = localStorage.getItem(`exp_filt_${i}`);
        const btn = $(`#fbtn-${i}`);
        if (memory && JSON.parse(memory).length > 0) {
            btn.addClass("filter-applied").text("APLICADO");
        } else {
            btn.removeClass("filter-applied").text("FILTRAR");
        }
    });

    if(chart) chart.destroy();
    chart = new Chart(document.getElementById('statusChart'), {
        type: 'pie',
        data: {
            labels: Object.keys(statsStatus).map(key => `${key} (${statsStatus[key]})`),
            datasets: [{ data: Object.values(statsStatus), backgroundColor: Object.keys(statsStatus).map(k => coresStatus[k] || "#ccc") }]
        },
        options: { 
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: { boxWidth: 15, font: { size: 12, weight: 'bold' } }
                }
            }
        }
    });
}

function aplicarFiltro() {
    const escolhidos = $("#listCheckboxes input:checked").map(function(){ return this.value; }).get();
    const regex = escolhidos.map(v => '^' + $.fn.dataTable.util.escapeRegex(v) + '$').join('|');
    table.column(curIdx).search(regex, true, false).draw();
    localStorage.setItem(`exp_filt_${curIdx}`, JSON.stringify(escolhidos));
    $("#modalFiltro").hide();
    updateDashboard();
}

function limparFiltroColuna() {
    localStorage.removeItem(`exp_filt_${curIdx}`);
    table.column(curIdx).search('').draw();
    $("#modalFiltro").hide();
    updateDashboard();
}

function restaurarFiltrosPermanentes() {
    colunas.forEach((_, i) => {
        const memory = JSON.parse(localStorage.getItem(`exp_filt_${i}`));
        if(memory && memory.length > 0) {
            const regex = memory.map(v => '^' + $.fn.dataTable.util.escapeRegex(v) + '$').join('|');
            table.column(i).search(regex, true, false);
        }
    });
    table.draw();
}

function openModal(idx, title) {
    curIdx = idx;
    $("#modalTitle").text(title);
    const unique = table.column(idx).data().unique().sort().toArray().map(v => $(`<span>${v}</span>`).text().trim());
    const list = $("#listCheckboxes").empty();
    const salvos = JSON.parse(localStorage.getItem(`exp_filt_${idx}`)) || unique;

    unique.forEach(v => {
        if(!v) return;
        let checked = salvos.includes(v) ? "checked" : "";
        list.append(`<label style="display:block; padding:8px; border-bottom:1px solid #eee; cursor:pointer;">
            <input type="checkbox" value="${v}" ${checked}> ${v}
        </label>`);
    });
    $("#modalFiltro").css("display", "flex");
}

function exportarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4');
    const filteredRows = table.rows({ search: 'applied' }).nodes().to$();
    
    doc.setFillColor(178, 34, 34); doc.rect(0, 0, 297, 25, 'F');
    doc.setTextColor(255, 255, 255); doc.setFontSize(28); doc.setFont("helvetica", "bold");
    doc.text("MS", 15, 17);
    doc.setFontSize(16); doc.text("EXPEDI√á√ÉO_M√ìVEIS SIMONETTI", 45, 15);
    
    let idsUnicosSet = new Set();
    let totalLinhas = 0;
    filteredRows.each(function(){ 
        idsUnicosSet.add($(this).attr('data-id')); 
        totalLinhas++;
    });

    doc.setFontSize(10); 
    doc.text(`TOTAL DE CARGAS: ${idsUnicosSet.size}`, 230, 12);
    doc.text(`TOTAL EXPEDI√á√ïES: ${totalLinhas}`, 230, 18);

    const bodyData = [];
    filteredRows.each(function() {
        const row = []; $(this).find('td').each(function() { row.push($(this).text().trim()); });
        bodyData.push(row);
    });

    doc.autoTable({
        startY: 35, head: [colunas], body: bodyData,
        styles: { fontSize: 8, halign: 'center', cellPadding: 3 },
        headStyles: { fillColor: [178, 34, 34] },
        didParseCell: function(data) {
            if(data.section === 'body' && (data.column.index === 7 || data.column.index === 8)) {
                const s = data.cell.raw.toUpperCase();
                const cor = data.column.index === 7 ? coresStatus[s] : coresVeic[s];
                if(cor) { data.cell.styles.textColor = hexToRgb(cor); data.cell.styles.fontStyle = 'bold'; }
            }
        }
    });
    doc.save("Relatorio_Expedicao_MS.pdf");
}

function hexToRgb(hex) {
    const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
    return [r, g, b];
}

function exportarExcel() {
    const wb = XLSX.utils.table_to_book(document.getElementById('tabelaExp'));
    XLSX.writeFile(wb, "Expedicao_Simonetti.xlsx");
}

function toggleChecks(b) { $("#listCheckboxes input").prop("checked", b); }
function fazerLogoff() { localStorage.clear(); window.location.href = "login.html"; }
</script>
</body>
</html>
